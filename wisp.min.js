String.prototype.regexIndexOf=function(a,b){var c=this.substring(b||0).search(a);return c>=0?c+(b||0):c};String.prototype.regexLastIndexOf=function(a,b){a=a.global?a:RegExp(a.source,"g"+(a.ignoreCase?"i":"")+(a.multiLine?"m":""));if(typeof b=="undefined")b=this.length;else if(b<0)b=0;for(var c=this.substring(0,b+1),d=-1,e,f=0;(e=a.exec(c))!==null;){d=e.index;a.lastIndex=++f}return d};String.prototype.isEmpty=function(){return this.length===0};var wisp={};wisp.EOF={type:"EOF"};wisp.EOL={type:"EOL"};
wisp.empty=[];wisp.isEmpty=function(a){return a instanceof Array&&a.length===0};wisp.isNumber=function(a){return typeof a==="number"};wisp.isSymbol=function(a){return typeof a==="string"};wisp.isBoolean=function(a){return typeof a==="boolean"};wisp.isAtom=function(a){return wisp.isNumber(a)||wisp.isBoolean(a)||wisp.isSymbol(a)};wisp.isNonEmptyCons=function(a){return a instanceof Array&&a.length===2};wisp.isCons=function(a){return wisp.isEmpty(a)||wisp.isNonEmptyCons(a)};
wisp.cons=function(a,b){if(!wisp.isCons(b))throw"Wisp error: must cons onto another list";return[a,b]};wisp.first=function(a){if(!wisp.isNonEmptyCons(a))throw"Wisp error: first is only defined for the non-empty lists";return a[0]};wisp.second=function(a){return wisp.first(wisp.rest(a))};wisp.third=function(a){return wisp.first(wisp.rest(wisp.rest(a)))};wisp.firsts=function(a){if(wisp.isEmpty(a))return a;return wisp.cons(wisp.first(wisp.first(a)),wisp.firsts(wisp.rest(a)))};
wisp.seconds=function(a){if(wisp.isEmpty(a))return a;return wisp.cons(wisp.second(wisp.first(a)),wisp.seconds(wisp.rest(a)))};wisp.rest=function(a){if(!wisp.isNonEmptyCons(a))throw"Wisp error: rest is only defined for the non-empty lists";return a[1]};
wisp.readIntoArray=function(a,b){if(a.length===0||a.length<=b.index)return wisp.EOF;var c=a.substring(b.index),d=c.trim()[0];if(d===")"){b.index+=c.indexOf(")")+1;return wisp.EOL}else if(d!=="("){d=c.indexOf(")");if(d===-1)d=Infinity;c=c.regexIndexOf(/\S\s/)+1;if(c<1)c=a.length-b.index;c=d<c?d:c;d=a.substring(b.index,b.index+c).trim();b.index+=c;return isNaN(parseFloat(d))?d:parseFloat(d)}else{b.index+=c.indexOf("(")+1;for(d=[];;){c=wisp.readIntoArray(a,b);if(c===wisp.EOF)throw"Error: end of file reached without reaching list end";
if(c===wisp.EOL)break;d.push(c)}return d}};wisp.read=function(a,b){if(b===undefined)b={index:0};return wisp.readIntoArray(a,b).toWispSexp()};Array.prototype.toWispSexp=function(){var a,b,c,d=wisp.empty;c=this.reverse();for(a=0;a<c.length;a++){b=c[a];if(b instanceof Array)b=b.toWispSexp();d=wisp.cons(b,d)}return d};
Array.prototype._toWispString=function(a){if(!wisp.isCons(this))throw"toWispString only applies to Wisp lists";if(wisp.isEmpty(this))return"";var b,c="";b=wisp.first(this);if(a)c="(";c+=wisp.isCons(b)?b._toWispString(true):b;b=wisp.rest(this)._toWispString(false);c+=b===""?"":" ";c+=b;if(a)c+=")";return c};Array.prototype.toWispString=function(){return this._toWispString(true)};wisp.parseIsNumber=function(a){return!isNaN(parseFloat(a))};wisp.parseIsBoolean=function(a){return a==="true"||a==="false"};
wisp.parseIsString=function(a){return a[0]==='"'&&a[a.length-1]==='"'};
wisp.parse=function(a){if(wisp.parseIsNumber(a))return{type:"num",val:parseFloat(a)};else if(wisp.parseIsBoolean(a))return{type:"bool",val:a==="true"};else if(wisp.parseIsString(a))return{type:"string",val:a.substring(1,a.length-1)};else if(wisp.isSymbol(a))return{type:"sym",val:a};else if(wisp.isCons(a))switch(wisp.first(a)){case "let":return{type:"app",funExpr:{type:"lambda",params:wisp.firsts(wisp.second(a)),body:wisp.parse(wisp.third(a))},argsExpr:{type:"argList",val:wisp.parseArgs(wisp.seconds(wisp.second(a)))}};
case "lambda":return{type:"lambda",params:wisp.second(a),body:wisp.parse(wisp.third(a))};case "cond":return{type:"cond",val:wisp.parseArgs(wisp.rest(a))};case "def":return{type:"def",param:wisp.second(a),body:wisp.parse(wisp.third(a))};default:return{type:"app",funExpr:wisp.parse(wisp.first(a)),argsExpr:{type:"argList",val:wisp.parseArgs(wisp.rest(a))}}}else throw"Parse Error: Given s-expression neither number, symbol, or cons";};
wisp.parseArgs=function(a){if(wisp.isEmpty(a))return a;return wisp.cons(wisp.parse(wisp.first(a)),wisp.parseArgs(wisp.rest(a)))};wisp.envLookup=function(a,b){var c=b[a];if(c===undefined)throw"given symbol name '"+a+"' not in environment";else return c};wisp.interpArgs=function(a,b){if(wisp.isEmpty(a))return a;return wisp.cons(wisp.interp(wisp.first(a),b),wisp.interpArgs(wisp.rest(a),b))};
wisp.interpCond=function(a,b){wisp.lastArgs=a;if(wisp.isEmpty(a))return a;var c=wisp.interp(wisp.first(a).funExpr,b);if(!wisp.isBoolean(c))throw"Error in evaluating condition: "+c+" is not a boolean";return c?wisp.first(wisp.interp(wisp.first(a).argsExpr,b)):wisp.interpCond(wisp.rest(a),b)};
wisp.addArgsToEnv=function(a,b,c){if(wisp.isEmpty(a)){c.argumentsList=b;return c}else if(wisp.isEmpty(b))throw"Wisp error: insufficient number of arguments given";else{var d=wisp.first(a),e=wisp.first(b);a=wisp.addArgsToEnv(wisp.rest(a),wisp.rest(b),c);a[d]=e;return a}};
wisp.interp=function(a,b){var c,d;switch(a.type){case "num":return a.val;case "bool":return a.val;case "string":return a.val;case "sym":return wisp.envLookup(a.val,b);case "argList":return wisp.interpArgs(a.val,b);case "cond":return wisp.interpCond(a.val,b);case "def":b[a.param]=wisp.interp(a.body,b);return a.param;case "lambda":return c=function(e){return wisp.interp(a.body,wisp.addArgsToEnv(a.params,e,b))};case "app":c=wisp.interp(a.funExpr,b);d=wisp.interp(a.argsExpr,b);return c(d);default:throw"Interpreter error, unknown abstract syntax type";
}};
wisp.basicEnv={"+":function(a){if(wisp.isEmpty(a))return 0;return wisp.first(a)+arguments.callee(wisp.rest(a))},"-":function(a){if(wisp.isEmpty(a))return 0;return wisp.first(a)-arguments.callee(wisp.rest(a))},"*":function(a){if(wisp.isEmpty(a))return 1;return wisp.first(a)*arguments.callee(wisp.rest(a))},"/":function(a){if(wisp.isEmpty(a))return 1;return wisp.first(a)/arguments.callee(wisp.rest(a))},"%":function(a){return wisp.first(a)%wisp.second(a)},list:function(a){return a},first:function(a){return wisp.first(wisp.first(a))},car:function(a){return wisp.first(wisp.first(a))},
rest:function(a){return wisp.rest(wisp.first(a))},cdr:function(a){return wisp.rest(wisp.first(a))},cons:function(a){return wisp.cons(wisp.first(a),wisp.second(a))},"cons?":function(a){return wisp.isCons(wisp.first(a))},"list?":function(a){return wisp.isCons(wisp.first(a))},"atom?":function(a){return wisp.isAtom(wisp.first(a))},empty:wisp.empty,"empty?":function(a){return wisp.isEmpty(wisp.first(a))},"eq?":function(a){var b=wisp.first(a),c=wisp.second(a);if(wisp.isAtom(b)&&wisp.isAtom(c))return b===
c;else if(wisp.isCons(b)&&wisp.isCons(c)){var d=[wisp.first(b),wisp.first(c)].toWispSexp();b=[wisp.rest(b),wisp.rest(c)].toWispSexp();return arguments.callee(d)&&arguments.callee(b)}else return false},"number?":function(a){return wisp.isNumber(wisp.first(a))},"boolean?":function(a){return wisp.isBoolean(wisp.first(a))},"string?":function(a){return wisp.isSymbol(wisp.first(a))},"else":true};var links=document.getElementsByTagName("link"),typePattern=/^text\/(x-)?wisp$/;wisp.scripts=[];var i;
for(i=0;i<links.length;i++)if(links[i].rel==="script/wisp"||links[i].rel.match(/script/)&&links[i].type.match(typePattern))wisp.scripts.push(links[i]);var val,sexps=[],parsed=[],env=wisp.basicEnv,advance={index:0};$.get(wisp.scripts[0].href,function(a){for(a=a.trim();advance.index<a.length;)sexps.push(wisp.read(a,advance));for(i=0;i<sexps.length;i++)val=wisp.interp(wisp.parse(sexps[i]),env);console.log(val);a=wisp.isCons(val)?val.toWispString():val;$("body").html("Wisp script returned: "+a)});